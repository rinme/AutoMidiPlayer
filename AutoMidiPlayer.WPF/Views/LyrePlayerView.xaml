<UserControl
	x:Class="AutoMidiPlayer.WPF.Views.LyrePlayerView"
	xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
	xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
	xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
	xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
	mc:Ignorable="d"
	xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
	xmlns:modern="http://schemas.modernwpf.com/2019"
	xmlns:s="https://github.com/canton7/Stylet"
	xmlns:viewModels="clr-namespace:AutoMidiPlayer.WPF.ViewModels"
	d:DataContext="{d:DesignInstance Type=viewModels:LyrePlayerViewModel}">
	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<!-- Header -->
		<TextBlock Grid.Row="0"
				   VerticalAlignment="Center"
				   FontSize="16"
				   Margin="0,0,0,10"
				   Text="{Binding Playlist.OpenedFile.Title, Mode=OneWay, FallbackValue=Select a song from Songs or Playlist}"/>

		<!-- Track Cards -->
		<ScrollViewer Grid.Row="1">
			<ItemsControl ItemsSource="{Binding MidiTracks}">
				<ItemsControl.ItemTemplate>
					<DataTemplate>
						<Border x:Name="TrackBorder"
								Margin="0,4"
								Padding="12,8"
								BorderThickness="2"
								CornerRadius="6"
								Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}">
							<Border.Style>
								<Style TargetType="Border">
									<Setter Property="BorderBrush" Value="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"/>
									<Setter Property="Effect">
										<Setter.Value>
											<DropShadowEffect 
												Color="#1DB954"
												BlurRadius="20"
												ShadowDepth="0"
												Opacity="0"/>
										</Setter.Value>
									</Setter>
									<Style.Triggers>
										<DataTrigger Binding="{Binding IsActive}" Value="True">
											<Setter Property="BorderBrush" Value="#1DB954"/>
											<DataTrigger.EnterActions>
												<BeginStoryboard>
													<Storyboard>
														<DoubleAnimation
															Storyboard.TargetProperty="(Border.Effect).(DropShadowEffect.Opacity)"
															To="1"
															Duration="0:0:0.05"/>
														<DoubleAnimation
															Storyboard.TargetProperty="(Border.Effect).(DropShadowEffect.BlurRadius)"
															To="25"
															Duration="0:0:0.05"/>
													</Storyboard>
												</BeginStoryboard>
											</DataTrigger.EnterActions>
											<DataTrigger.ExitActions>
												<BeginStoryboard>
													<Storyboard>
														<DoubleAnimation
															Storyboard.TargetProperty="(Border.Effect).(DropShadowEffect.Opacity)"
															To="0"
															Duration="0:0:0.2"/>
														<DoubleAnimation
															Storyboard.TargetProperty="(Border.Effect).(DropShadowEffect.BlurRadius)"
															To="20"
															Duration="0:0:0.2"/>
													</Storyboard>
												</BeginStoryboard>
											</DataTrigger.ExitActions>
										</DataTrigger>
									</Style.Triggers>
								</Style>
							</Border.Style>
							<Grid>
								<Grid.ColumnDefinitions>
									<ColumnDefinition Width="Auto"/>
									<ColumnDefinition Width="*"/>
								</Grid.ColumnDefinitions>

								<!-- Toggle and Track Name -->
								<modern:ToggleSwitch Grid.Column="0"
													 IsOn="{Binding IsChecked}"
													 IsEnabled="{Binding CanBePlayed}"
													 OffContent="{Binding TrackName, TargetNullValue=Unknown}"
													 OnContent="{Binding TrackName, TargetNullValue=Unknown}"
													 MinWidth="180">
									<modern:ToggleSwitch.Style>
										<Style TargetType="modern:ToggleSwitch">
											<Style.Triggers>
												<Trigger Property="IsEnabled"
														 Value="False">
													<Setter Property="ToolTip"
															Value="Cannot disable track containing tempo settings."/>
													<Setter Property="ToolTipService.ShowOnDisabled"
															Value="True"/>
												</Trigger>
											</Style.Triggers>
										</Style>
									</modern:ToggleSwitch.Style>
								</modern:ToggleSwitch>

								<!-- Statistics -->
								<modern:SimpleStackPanel Grid.Column="1"
														 Orientation="Horizontal"
														 HorizontalAlignment="Right"
														 Spacing="16">
									<StackPanel ToolTip="Total number of notes">
										<TextBlock Text="Notes"
												   FontSize="10"
												   Opacity="0.6"
												   HorizontalAlignment="Center"/>
										<TextBlock Text="{Binding NotesCountDisplay}"
												   FontWeight="SemiBold"
												   HorizontalAlignment="Center"/>
									</StackPanel>
									<StackPanel ToolTip="Percentage of black keys (sharps/flats)">
										<TextBlock Text="Black Keys"
												   FontSize="10"
												   Opacity="0.6"
												   HorizontalAlignment="Center"/>
										<TextBlock Text="{Binding BlackKeyRatioDisplay}"
												   FontWeight="SemiBold"
												   HorizontalAlignment="Center"/>
									</StackPanel>
									<StackPanel ToolTip="Average note duration">
										<TextBlock Text="Avg Duration"
												   FontSize="10"
												   Opacity="0.6"
												   HorizontalAlignment="Center"/>
										<TextBlock Text="{Binding AverageDurationDisplay}"
												   FontWeight="SemiBold"
												   HorizontalAlignment="Center"/>
									</StackPanel>
									<StackPanel ToolTip="Ratio of frequently repeating notes">
										<TextBlock Text="Frequent"
												   FontSize="10"
												   Opacity="0.6"
												   HorizontalAlignment="Center"/>
										<TextBlock Text="{Binding FrequentNotesRatioDisplay}"
												   FontWeight="SemiBold"
												   HorizontalAlignment="Center"/>
									</StackPanel>
								</modern:SimpleStackPanel>
							</Grid>
						</Border>
					</DataTemplate>
				</ItemsControl.ItemTemplate>
			</ItemsControl>
		</ScrollViewer>

		<!-- MIDI Instrument Selection -->
		<GroupBox Grid.Row="2"
				  Header="MIDI Instrument"
				  Margin="0,10,0,0">
			<modern:SimpleStackPanel Orientation="Horizontal">
				<ComboBox
					ItemsSource="{Binding MidiInputs}"
					SelectedItem="{Binding SelectedMidiInput}"
					DisplayMemberPath="DeviceName"/>
				<Button Command="{s:Action RefreshDevices}"
						ToolTip="Refresh MIDI devices">
					<ui:FontIcon Glyph="&#xE72C;"
								 FontFamily="{StaticResource MdlFontFamily}"/>
				</Button>
			</modern:SimpleStackPanel>
		</GroupBox>
	</Grid>
</UserControl>
