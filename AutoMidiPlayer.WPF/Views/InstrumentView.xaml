<UserControl
    x:Class="AutoMidiPlayer.WPF.Views.InstrumentView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    mc:Ignorable="d"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:s="https://github.com/canton7/Stylet"
    xmlns:core="clr-namespace:AutoMidiPlayer.WPF.Core"
    xmlns:controls="clr-namespace:AutoMidiPlayer.WPF.Controls"
    xmlns:converters="clr-namespace:AutoMidiPlayer.WPF.Converters"
    xmlns:viewModels="clr-namespace:AutoMidiPlayer.WPF.ViewModels"
    xmlns:properties="clr-namespace:AutoMidiPlayer.Data.Properties;assembly=AutoMidiPlayer.Data"
    d:DataContext="{d:DesignInstance Type=viewModels:InstrumentViewModel}">
    <UserControl.Resources>
        <properties:Settings x:Key="Settings"/>
        <converters:DateTimeToTimeSpanConverter x:Key="DateTimeToTimeSpanConverter"/>
    </UserControl.Resources>

    <ScrollViewer>
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Column -->
            <controls:SimpleStackPanel Grid.Column="0"
                                       Margin="0,0,10,0">

                <!-- Instrument Section -->
                <TextBlock Text="Game Instrument"
                           Style="{DynamicResource SubtitleTextBlockStyle}"
                           Margin="0,0,0,8"/>
                <ComboBox
                    ItemsSource="{x:Static core:Keyboard.InstrumentNames}"
                    SelectedItem="{Binding SelectedInstrument}"
                    SelectedIndex="{Binding Default.SelectedInstrument, Source={StaticResource Settings}}"
                    DisplayMemberPath="Value"
                    MinWidth="200"/>

                <TextBlock Text="Keyboard Layout"
                           Style="{DynamicResource SubtitleTextBlockStyle}"
                           Margin="0,16,0,8"/>
                <ComboBox
                    ItemsSource="{x:Static core:Keyboard.LayoutNames}"
                    SelectedItem="{Binding SelectedLayout}"
                    SelectedIndex="{Binding Default.SelectedLayout, Source={StaticResource Settings}}"
                    DisplayMemberPath="Value"
                    MinWidth="200"/>

                <ui:ToggleSwitch
                    Content="Test Mode (Speakers)"
                    IsEnabled="{Binding CanUseSpeakers}"
                    IsChecked="{Binding Default.UseSpeakers, Source={StaticResource Settings}}"
                    Margin="0,8,0,0"/>

                <!-- Timer Section -->
                <TextBlock Text="Timer"
                           Style="{DynamicResource SubtitleTextBlockStyle}"
                           Margin="0,16,0,8"/>

                <TextBlock Text="Scheduled Playback"
                           Style="{DynamicResource SubtitleTextBlockStyle}"
                           Margin="0,0,0,8"/>

                <controls:SimpleStackPanel Orientation="Horizontal">
                    <controls:SimpleStackPanel.Resources>
                        <Style TargetType="Button"
                               BasedOn="{StaticResource {x:Type Button}}"/>
                    </controls:SimpleStackPanel.Resources>
                    <ui:TimePicker SelectedTime="{Binding DateTime, Mode=TwoWay, Converter={StaticResource DateTimeToTimeSpanConverter}}"
                                   IsEnabled="{Binding CanChangeTime}"/>
                    <Button Command="{s:Action SetTimeToNow}"
                            IsEnabled="{Binding CanChangeTime}">Now</Button>
                    <Button Command="{s:Action StartStopTimer}"
                            Content="{Binding TimerText}"/>
                </controls:SimpleStackPanel>
            </controls:SimpleStackPanel>

            <!-- Right Column -->
            <controls:SimpleStackPanel Grid.Column="1"
                                       Margin="10,0,0,0">

                <!-- Notes Section -->
                <TextBlock Text="Notes"
                           Style="{DynamicResource SubtitleTextBlockStyle}"
                           Margin="0,0,0,8"/>

                <TextBlock Text="Open a song to configure these settings"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           Visibility="{Binding HasSongOpen, Converter={x:Static s:BoolToVisibilityConverter.InverseInstance}}"
                           Margin="0,0,0,8"/>

                <controls:SimpleStackPanel Orientation="Horizontal"
                                           Spacing="20"
                                           IsEnabled="{Binding HasSongOpen}">
                    <ui:ToggleSwitch
                        Content="Merge nearby notes"
                        IsChecked="{Binding MergeNotes}"/>
                    <ui:NumberBox
                        PlaceholderText="Tolerance (ms)"
                        IsEnabled="{Binding MergeNotes}"
                        Value="{Binding MergeMilliseconds}"
                        MinWidth="100"/>
                </controls:SimpleStackPanel>

                <ui:ToggleSwitch
                    Content="Hold notes"
                    IsChecked="{Binding HoldNotes}"
                    IsEnabled="{Binding HasSongOpen}"/>

                <!-- MIDI Input Section -->
                <TextBlock Text="MIDI Input"
                           Style="{DynamicResource SubtitleTextBlockStyle}"
                           Margin="0,0,0,8"/>

                <GroupBox Header="Physical MIDI Instrument">
                    <controls:SimpleStackPanel Orientation="Horizontal">
                        <ComboBox
                            ItemsSource="{Binding MidiInputs}"
                            SelectedItem="{Binding SelectedMidiInput}"
                            DisplayMemberPath="DeviceName"
                            MinWidth="200"/>
                        <Button Command="{s:Action RefreshDevices}"
                                ToolTip="Refresh MIDI devices"
                                Background="Transparent">
                            <ui:FontIcon Glyph="&#xE72C;"
                                         FontFamily="{StaticResource MdlFontFamily}"/>
                        </Button>
                    </controls:SimpleStackPanel>
                </GroupBox>

                <TextBlock Text="Connect a physical MIDI keyboard or controller to use it as input."
                           TextWrapping="Wrap"
                           Opacity="0.6"
                           FontSize="12"
                           Margin="0,8,0,0"/>
            </controls:SimpleStackPanel>


        </Grid>
    </ScrollViewer>
</UserControl>
