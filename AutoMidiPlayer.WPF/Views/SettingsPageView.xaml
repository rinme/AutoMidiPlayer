<UserControl
    x:Class="AutoMidiPlayer.WPF.Views.SettingsPageView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    mc:Ignorable="d"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:modern="http://schemas.modernwpf.com/2019"
    xmlns:s="https://github.com/canton7/Stylet"
    xmlns:theme="clr-namespace:AutoMidiPlayer.WPF.ModernWPF.Theme"
    xmlns:core="clr-namespace:AutoMidiPlayer.WPF.Core"
    xmlns:viewModels="clr-namespace:AutoMidiPlayer.WPF.ViewModels"
    xmlns:transitions="clr-namespace:AutoMidiPlayer.WPF.ModernWPF.Animation.Transitions"
    xmlns:properties="clr-namespace:AutoMidiPlayer.Data.Properties;assembly=AutoMidiPlayer.Data"
    d:DataContext="{d:DesignInstance Type=viewModels:SettingsPageViewModel}">
    <UserControl.Resources>
        <theme:AppThemeConverter x:Key="AppThemeConverter"/>
        <properties:Settings x:Key="Settings"/>
    </UserControl.Resources>

    <ScrollViewer>
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Column -->
            <modern:SimpleStackPanel Grid.Column="0"
                                     Margin="0,0,10,0">

                <!-- Player Section -->
                <TextBlock Text="Player"
                           Style="{DynamicResource SubtitleTextBlockStyle}"
                           Margin="0,0,0,8"/>

                <modern:SimpleStackPanel Orientation="Horizontal"
                                         Spacing="20">
                    <modern:ToggleSwitch
                        Header="Test Mode (Speakers)"
                        IsEnabled="{Binding CanUseSpeakers}"
                        IsOn="{Binding Default.UseSpeakers, Source={StaticResource Settings}}"/>
                </modern:SimpleStackPanel>

                <modern:SimpleStackPanel Orientation="Horizontal"
                                         Spacing="20">
                    <modern:ToggleSwitch
                        Header="Hold notes"
                        IsOn="{Binding Default.HoldNotes, Source={StaticResource Settings}}"/>
                    <modern:ToggleSwitch
                        Header="Merge nearby notes"
                        IsOn="{Binding MergeNotes}"/>
                    <modern:NumberBox
                        Header="Tolerance (ms)"
                        IsEnabled="{Binding MergeNotes}"
                        Value="{Binding MergeMilliseconds}"
                        MinWidth="100"/>
                </modern:SimpleStackPanel>

                <modern:SimpleStackPanel Orientation="Horizontal"
                                         Spacing="10">
                    <GroupBox Header="Layout">
                        <ComboBox
                            ItemsSource="{x:Static core:Keyboard.LayoutNames}"
                            SelectedItem="{Binding SelectedLayout}"
                            SelectedIndex="{Binding Default.SelectedLayout, Source={StaticResource Settings}}"
                            DisplayMemberPath="Value"
                            MinWidth="120"/>
                    </GroupBox>
                    <GroupBox Header="Instrument">
                        <ComboBox
                            ItemsSource="{x:Static core:Keyboard.InstrumentNames}"
                            SelectedItem="{Binding SelectedInstrument}"
                            SelectedIndex="{Binding Default.SelectedInstrument, Source={StaticResource Settings}}"
                            DisplayMemberPath="Value"
                            MinWidth="150"/>
                    </GroupBox>
                </modern:SimpleStackPanel>

                <GroupBox Header="Timer">
                    <modern:SimpleStackPanel Orientation="Horizontal">
                        <modern:SimpleStackPanel.Resources>
                            <Style TargetType="Button"
                                   BasedOn="{StaticResource {x:Type Button}}"/>
                        </modern:SimpleStackPanel.Resources>
                        <modern:SimpleTimePicker SelectedDateTime="{Binding DateTime}"
                                                 IsEnabled="{Binding CanChangeTime}"/>
                        <Button Command="{s:Action SetTimeToNow}"
                                IsEnabled="{Binding CanChangeTime}">Now</Button>
                        <Button Command="{s:Action StartStopTimer}"
                                Content="{Binding TimerText}"/>
                    </modern:SimpleStackPanel>
                </GroupBox>

                <!-- Locations Section -->
                <TextBlock Text="Locations"
                           Style="{DynamicResource SubtitleTextBlockStyle}"
                           Margin="0,16,0,8"/>

                <GroupBox Header="Game Location">
                    <modern:SimpleStackPanel Orientation="Horizontal">
                        <Button Command="{s:Action SetLocation}"
                                Background="Transparent">
                            <ui:FontIcon Glyph="&#xE8E5;"
                                         FontFamily="{StaticResource MdlFontFamily}"/>
                        </Button>
                        <TextBlock Text="{x:Static viewModels:SettingsPageViewModel.GenshinLocation}"
                                   VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis"/>
                    </modern:SimpleStackPanel>
                </GroupBox>

                <GroupBox Header="MIDI Folder">
                    <modern:SimpleStackPanel Orientation="Horizontal">
                        <Button Command="{s:Action BrowseMidiFolder}"
                                Background="Transparent"
                                ToolTip="Browse for MIDI folder">
                            <ui:FontIcon Glyph="&#xE838;"
                                         FontFamily="{StaticResource MdlFontFamily}"/>
                        </Button>
                        <TextBlock Text="{Binding MidiFolder, TargetNullValue='No folder selected'}"
                                   VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis"
                                   MaxWidth="200"/>
                        <Button Command="{s:Action ScanMidiFolder}"
                                Background="Transparent"
                                ToolTip="Refresh/Scan folder for new MIDI files"
                                Visibility="{Binding HasMidiFolder, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
                            <ui:FontIcon Glyph="&#xE72C;"
                                         FontFamily="{StaticResource MdlFontFamily}"/>
                        </Button>
                        <Button Command="{s:Action ClearMidiFolder}"
                                Background="Transparent"
                                ToolTip="Clear MIDI folder"
                                Visibility="{Binding HasMidiFolder, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
                            <ui:FontIcon Glyph="&#xE711;"
                                         FontFamily="{StaticResource MdlFontFamily}"/>
                        </Button>
                    </modern:SimpleStackPanel>
                </GroupBox>

                <!-- License Section -->
                <TextBlock Text="License"
                           Style="{DynamicResource SubtitleTextBlockStyle}"
                           Margin="0,16,0,8"/>

                <modern:SimpleStackPanel Spacing="4">
                    <TextBlock TextWrapping="Wrap"
                               FontSize="12">
                        Originally created by © 2022 sabihoshi. Modified by © 2026 Jed556 for multi-game support.
                        Licensed under the
                        <Hyperlink NavigateUri="{Binding Default.LicenseUri, Source={StaticResource Settings}}">MIT License</Hyperlink>.
                    </TextBlock>
                    <TextBlock TextWrapping="Wrap"
                               FontSize="12">
                        This project uses third-party libraries that may be distributed under
                        <Hyperlink NavigateUri="{Binding Default.ThirdPartyLicenseUri, Source={StaticResource Settings}}">different licenses</Hyperlink>.
                    </TextBlock>
                    <TextBlock TextWrapping="Wrap"
                               FontSize="11"
                               Opacity="0.7">
                        All rights reserved by © miHoYo Co., Ltd. and © XD Inc.
                        Not affiliated with miHoYo or XD.
                    </TextBlock>
                </modern:SimpleStackPanel>
            </modern:SimpleStackPanel>

            <!-- Right Column -->
            <modern:SimpleStackPanel Grid.Column="1"
                                     Margin="10,0,0,0">

                <!-- Version Section -->
                <TextBlock Text="Version"
                           Style="{DynamicResource SubtitleTextBlockStyle}"
                           Margin="0,0,0,8"/>

                <modern:SimpleStackPanel Orientation="Horizontal"
                                         Spacing="8">
                    <TextBlock VerticalAlignment="Center">
                        v<Run Text="{Binding ProgramVersion, Mode=OneTime}"/>
                    </TextBlock>
                    <Button Command="{s:Action CheckForUpdate}"
                            Background="Transparent"
                            Padding="4"
                            ToolTip="Check for updates"
                            Visibility="{Binding IsCheckingUpdate, Converter={x:Static s:BoolToVisibilityConverter.InverseInstance}}">
                        <ui:FontIcon Glyph="&#xE72C;"
                                     FontFamily="{StaticResource MdlFontFamily}"
                                     FontSize="14"/>
                    </Button>
                    <ui:ProgressRing
                        IsIndeterminate="True"
                        Width="16"
                        Height="16"
                        IsEnabled="{Binding IsCheckingUpdate}"
                        Visibility="{Binding IsCheckingUpdate, Converter={x:Static s:BoolToVisibilityConverter.Instance}}"/>
                </modern:SimpleStackPanel>

                <TextBlock Visibility="{Binding NeedsUpdate, Converter={x:Static s:BoolToVisibilityConverter.Instance}}"
                           Margin="0,4,0,0">
                    Update available:
                    <Hyperlink NavigateUri="{Binding LatestVersion.Url}">
                        <Run Text="{Binding LatestVersion.TagName}"/>
                    </Hyperlink>
                </TextBlock>

                <modern:ToggleSwitch Header="Auto-check updates"
                                     IsOn="{Binding AutoCheckUpdates}"/>
                <modern:ToggleSwitch Header="Include beta updates"
                                     IsOn="{Binding IncludeBetaUpdates}"/>

                <!-- Style Section -->
                <TextBlock Text="Style"
                           Style="{DynamicResource SubtitleTextBlockStyle}"
                           Margin="0,16,0,8"/>

                <GroupBox Header="Theme Mode">
                    <modern:RadioButtons
                        SelectedItem="{Binding
                            Source={x:Static modern:ThemeManager.Current}, Path=ApplicationTheme,
                            Converter={StaticResource AppThemeConverter}}"
                        SelectionChanged="{s:Action OnThemeChanged}"
                        SelectedIndex="{Binding Default.AppTheme, Source={StaticResource Settings}}">
                        <modern:RadioButtons.ItemsSource>
                            <theme:AppThemes/>
                        </modern:RadioButtons.ItemsSource>
                    </modern:RadioButtons>
                </GroupBox>

                <GroupBox Header="Accent Color">
                    <ComboBox
                        SelectedItem="{Binding SelectedAccentColor}"
                        ItemsSource="{x:Static viewModels:SettingsPageViewModel.AccentColors}"
                        MinWidth="150">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Border Width="16"
                                            Height="16"
                                            CornerRadius="8"
                                            Background="{Binding ColorBrush}"
                                            Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding Name}"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </GroupBox>

                <GroupBox Header="Transition Style">
                    <ComboBox
                        SelectedItem="{Binding Transition}"
                        SelectedIndex="{Binding Default.SelectedTransition, Source={StaticResource Settings}}"
                        ItemsSource="{x:Static transitions:TransitionCollection.Transitions}"
                        MinWidth="150"/>
                </GroupBox>
            </modern:SimpleStackPanel>
        </Grid>
    </ScrollViewer>
</UserControl>
