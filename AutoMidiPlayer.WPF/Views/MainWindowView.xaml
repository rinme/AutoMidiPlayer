<ui:UiWindow
	x:Class="AutoMidiPlayer.WPF.Views.MainWindowView"
	xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
	xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
	xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
	xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
	mc:Ignorable="d"
	xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
	xmlns:modern="http://schemas.modernwpf.com/2019"
	xmlns:s="https://github.com/canton7/Stylet"
	xmlns:pages="clr-namespace:AutoMidiPlayer.WPF.Views"
	xmlns:modernWpf="clr-namespace:AutoMidiPlayer.WPF.ModernWPF"
	xmlns:viewModels="clr-namespace:AutoMidiPlayer.WPF.ViewModels"
	xmlns:core="clr-namespace:AutoMidiPlayer.WPF.Core"
	d:DataContext="{d:DesignInstance Type=viewModels:MainWindowViewModel}"
	x:Name="MainWindow"
	Title="{Binding Title}"
	Height="650"
	Width="1000"
	MinWidth="800"
	MinHeight="550"
	Background="{ui:ThemeResource ApplicationBackgroundBrush}"
	ExtendsContentIntoTitleBar="True"
	WindowBackdropType="Mica"
	WindowCornerPreference="Round"
	WindowStartupLocation="CenterScreen">

	<ui:UiWindow.Resources>
		<modernWpf:BindingProxy x:Key="DataContextProxy"
								Data="{Binding}"/>
	</ui:UiWindow.Resources>

	<Grid AllowDrop="True"
		  Drop="{s:Action OnFileDrop}"
		  DragOver="{s:Action OnDragOver}"
		  Background="Transparent">
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<!-- Title Bar -->
		<ui:TitleBar Grid.Row="0"
					 Title="{Binding Title}">
			<ui:TitleBar.Header>
				<modern:SimpleStackPanel Margin="250,0,0,0"
										 Orientation="Horizontal">
					<ui:Hyperlink
						VerticalAlignment="Center"
						Command="{s:Action NavigateToSettings}"
						Visibility="{Binding ShowUpdate, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
						New update!
					</ui:Hyperlink>
				</modern:SimpleStackPanel>
			</ui:TitleBar.Header>
			<ui:TitleBar.Tray>
				<ui:NotifyIcon FocusOnLeftClick="True"
							   MenuOnRightClick="True"
							   TooltipText="MIDI Player">
					<ui:NotifyIcon.Menu>
						<ContextMenu>
							<ui:MenuItem s:View.ActionTarget="{Binding Data.TrackView, Source={StaticResource DataContextProxy}}"
										 Command="{s:Action PlayPause}"
										 Header="Play"
										 SymbolIcon="Play16"/>
							<ui:MenuItem s:View.ActionTarget="{Binding Data.TrackView, Source={StaticResource DataContextProxy}}"
										 Command="{s:Action Next}"
										 Header="Next"
										 SymbolIcon="Next16"/>
						</ContextMenu>
					</ui:NotifyIcon.Menu>
				</ui:NotifyIcon>
			</ui:TitleBar.Tray>
		</ui:TitleBar>

		<!-- Main Content Area -->
		<Grid Grid.Row="1">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="Auto"/>
				<ColumnDefinition Width="*"/>
			</Grid.ColumnDefinitions>

			<!-- Left Navigation -->
			<ui:NavigationStore
				x:Name="RootNavigation"
				Margin="6,0"
				Precache="False"
				SelectedPageIndex="0"
				Navigated="{s:Action Navigate}"
				Frame="{Binding ElementName=RootFrame, Mode=OneWay}">
				<ui:NavigationStore.Items>
					<ui:NavigationItem Content="Tracks"
									   Icon="MusicNote220"
									   PageType="{x:Type pages:TrackView}"
									   Tag="{Binding TrackView}"/>
					<ui:NavigationItem Content="Sheet"
									   Icon="BookOpenMicrophone20"
									   PageType="{x:Type pages:PianoSheetView}"
									   Tag="{Binding PianoSheetView}"/>
					<ui:NavigationItem Content="Instrument"
									   Icon="MusicNote2Play20"
									   PageType="{x:Type pages:InstrumentView}"
									   Tag="{Binding InstrumentView}"/>
					<ui:NavigationItem Content="Queue"
									   Icon="TextBulletListSquareSearch20"
									   PageType="{x:Type pages:QueueView}"
									   Tag="{Binding QueueView}"/>
					<ui:NavigationItem Content="Songs"
									   Icon="MusicNote120"
									   PageType="{x:Type pages:SongsView}"
									   Tag="{Binding SongsView}"/>
				</ui:NavigationStore.Items>
				<ui:NavigationStore.Footer>
					<ui:NavigationItem Content="Theme"
									   Icon="DarkTheme24"
									   Command="{s:Action ToggleTheme}"/>
					<ui:NavigationItem Content="Settings"
									   Icon="Settings16"
									   PageType="{x:Type pages:SettingsPageView}"
									   Tag="{Binding SettingsView}"/>
				</ui:NavigationStore.Footer>
			</ui:NavigationStore>

			<!-- Content Panel -->
			<Border Grid.Column="1"
					CornerRadius="8,0,0,0"
					Background="{ui:ThemeResource ControlFillColorDefaultBrush}">
				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="*"/>
					</Grid.RowDefinitions>
					<ui:Breadcrumb
						Grid.Row="0"
						Margin="18,8,18,4"
						Padding="0"
						HorizontalAlignment="Left"
						VerticalAlignment="Top"
						FontSize="24"
						Navigation="{Binding ElementName=RootNavigation, Mode=OneWay}"/>
					<Frame Grid.Row="0"
						   x:Name="RootFrame"
						   Visibility="Hidden"/>
					<modernWpf:AnimatedContentControl Grid.Row="1"
													  Margin="16,4,16,10"
													  s:View.Model="{Binding ActiveItem}"/>
				</Grid>
			</Border>
		</Grid>

		<!-- Fixed Bottom Player Controls (Spotify-style) -->
		<Border Grid.Row="2"
				Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
				BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
				BorderThickness="0,1,0,0"
				Padding="16,12">
			<Grid>
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="*"
									  MinWidth="180"/>
					<ColumnDefinition Width="Auto"/>
					<ColumnDefinition Width="*"
									  MinWidth="180"/>
				</Grid.ColumnDefinitions>

				<!-- Left: Song Info -->
				<StackPanel Grid.Column="0"
							Orientation="Horizontal"
							VerticalAlignment="Center">
					<Border Width="56"
							Height="56"
							CornerRadius="4"
							Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}">
						<ui:FontIcon Glyph="&#xEC4F;"
									 FontFamily="{StaticResource MdlFontFamily}"
									 FontSize="24"/>
					</Border>
					<StackPanel Margin="12,0,0,0"
								VerticalAlignment="Center">
						<TextBlock Text="{Binding TrackView.Queue.OpenedFile.Title, FallbackValue=No song playing}"
								   FontWeight="SemiBold"
								   FontSize="14"
								   TextTrimming="CharacterEllipsis"
								   MaxWidth="200"/>
						<TextBlock Text="{Binding TrackView.Queue.OpenedFile.Song.Author, FallbackValue=Unknown artist}"
								   Opacity="0.6"
								   FontSize="12"
								   TextTrimming="CharacterEllipsis"
								   MaxWidth="200"/>
					</StackPanel>
				</StackPanel>

				<!-- Center: Playback Controls -->
				<StackPanel Grid.Column="1"
							HorizontalAlignment="Center">
					<!-- Control Buttons -->
					<modern:SimpleStackPanel Orientation="Horizontal"
											 HorizontalAlignment="Center"
											 Spacing="4">
						<Button s:View.ActionTarget="{Binding TrackView.Queue}"
								Command="{s:Action ToggleShuffle}"
								Style="{StaticResource PlayerControlButton}"
								ToolTip="Shuffle">
							<ui:FontIcon Glyph="&#xE14B;"
										 FontFamily="{StaticResource MdlFontFamily}"
										 FontSize="14"
										 Foreground="{Binding TrackView.Queue.ShuffleStateColor}"/>
						</Button>

						<Button s:View.ActionTarget="{Binding TrackView}"
								Command="{s:Action Previous}"
								IsHitTestVisible="{Binding TrackView.CanHitPrevious}"
								Style="{StaticResource PlayerControlButton}"
								ToolTip="Previous">
							<ui:FontIcon Glyph="&#xE892;"
										 FontFamily="{StaticResource MdlFontFamily}"
										 FontSize="16"/>
						</Button>

						<Button s:View.ActionTarget="{Binding TrackView}"
								Command="{s:Action PlayPause}"
								IsHitTestVisible="{Binding TrackView.CanHitPlayPause}"
								Style="{StaticResource PlayPauseButton}"
								ToolTip="{Binding TrackView.PlayPauseTooltip}">
							<ui:FontIcon Glyph="{Binding TrackView.PlayPauseIcon}"
										 FontFamily="{StaticResource MdlFontFamily}"
										 FontSize="16"
										 Foreground="{DynamicResource SystemControlBackgroundAltHighBrush}"/>
						</Button>

						<Button s:View.ActionTarget="{Binding TrackView}"
								Command="{s:Action Next}"
								IsHitTestVisible="{Binding TrackView.CanHitNext}"
								Style="{StaticResource PlayerControlButton}"
								ToolTip="Next">
							<ui:FontIcon Glyph="&#xE893;"
										 FontFamily="{StaticResource MdlFontFamily}"
										 FontSize="16"/>
						</Button>

						<Button s:View.ActionTarget="{Binding TrackView.Queue}"
								Command="{s:Action ToggleLoop}"
								Style="{StaticResource PlayerControlButton}"
								ToolTip="{Binding TrackView.Queue.LoopTooltip}">
							<ui:FontIcon Glyph="{Binding TrackView.Queue.LoopStateString}"
										 FontFamily="{StaticResource MdlFontFamily}"
										 FontSize="14"/>
						</Button>
					</modern:SimpleStackPanel>

					<!-- Progress Bar -->
					<Grid Margin="0,8,0,0"
						  MinWidth="400">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="Auto"/>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>

						<TextBlock Grid.Column="0"
								   VerticalAlignment="Center"
								   FontSize="11"
								   Opacity="0.7"
								   Text="{Binding TrackView.CurrentTime, StringFormat=m\\:ss}"/>
						<Slider Grid.Column="1"
								Margin="8,0"
								IsMoveToPointEnabled="True"
								IsEnabled="{Binding TrackView.CanHitPlayPause}"
								Value="{Binding TrackView.SongPosition}"
								Maximum="{Binding TrackView.MaximumTime.TotalSeconds}"
								IsSelectionRangeEnabled="True"
								SelectionStart="0"
								SelectionEnd="{Binding TrackView.SongPosition, Mode=OneWay}"/>
						<TextBlock Grid.Column="2"
								   VerticalAlignment="Center"
								   FontSize="11"
								   Opacity="0.7"
								   Text="{Binding TrackView.MaximumTime, StringFormat=m\\:ss}"/>
					</Grid>
				</StackPanel>

				<!-- Right: Per-song Settings -->
				<modern:SimpleStackPanel Grid.Column="2"
										 Orientation="Horizontal"
										 HorizontalAlignment="Right"
										 VerticalAlignment="Center"
										 Spacing="12">

					<!-- Key -->
					<StackPanel ToolTip="Key offset for transposition">
						<TextBlock Text="Key"
								   FontSize="10"
								   Opacity="0.6"
								   HorizontalAlignment="Center"/>
						<ComboBox MinWidth="90"
								  MaxHeight="24"
								  Padding="8,2"
								  ItemsSource="{Binding SettingsView.KeyOptions}"
								  SelectedItem="{Binding SettingsView.SelectedKeyOption}"
								  DisplayMemberPath="Display"/>
					</StackPanel>

					<!-- Speed -->
					<StackPanel ToolTip="Playback speed">
						<TextBlock Text="Speed"
								   FontSize="10"
								   Opacity="0.6"
								   HorizontalAlignment="Center"/>
						<ComboBox MinWidth="70"
								  MaxHeight="24"
								  Padding="8,2"
								  ItemsSource="{Binding SettingsView.SpeedOptions}"
								  SelectedItem="{Binding SettingsView.SelectedSpeedOption}"
								  DisplayMemberPath="Display"/>
					</StackPanel>

					<!-- Transpose Mode -->
					<StackPanel ToolTip="Transpose mode for out-of-range notes">
						<TextBlock Text="Transpose"
								   FontSize="10"
								   Opacity="0.6"
								   HorizontalAlignment="Center"/>
						<ComboBox MinWidth="80"
								  MaxHeight="24"
								  Padding="8,2"
								  ItemsSource="{x:Static viewModels:SettingsPageViewModel.TransposeNames}"
								  SelectedItem="{Binding SettingsView.Transpose}"
								  DisplayMemberPath="Value"/>
					</StackPanel>
				</modern:SimpleStackPanel>
			</Grid>
		</Border>
	</Grid>
</ui:UiWindow>
